# umm-spec-lib

The UMM Spec lib contains JSON schemas that defined the Unified Metadata Model. The UMM defines common data structures for representing metadata. The UMM Spec Lib also contains custom JSON files that define mappings between the XML metadata standards (ECHO10, DIF 9, DIF 10, ISO 19115 SMAP and ISO 19115 MENDS) and the UMM. The UMM is represented as Clojure records in the UMM Spec lib. The mappings provide a way for programmatic conversion between XML and UMM.

## Library Layout

Lists major parts of the library.

  * src/cmr/umm-spec/
    * models/ - Contains clojure namespaces that were generated from the UMM JSON schemas.
    * json_schema.clj - Contains code for loading JSON schemas.
    * record_generator.clj - Generates clojure records from json schemas. Must be manually done when the JSON schemas are updated.
    * xml_mappings.clj - Code for loading XML mappings.
    * xml_generation.clj - Contains functions for generating XML from UMM and mappings.
    * xml_parsing.clj - Contains functions for parsing XML into UMM records.
  * resources/
    * json-schemas/ - Contains the UMM JSON schemas
    * mappings/ - Contains files defining mappings between XML and UMM.


## Generating Clojure Records from UMM JSON Schemas

The JSON schemas in `resource/json-schemas` define the structure of the UMM. These are used as source documents for generating Clojure records that can store the same data as the UMM. The records are generated into `src/cmr/umm-spec/models`.

JSON schemas can define complex types like the following example:

```
{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "title": "Book",
  "type": "object",
  "properties": {
    "Author": {
      "description": "The author of this book",
      "$ref": "umm-cmn-json-schema.json#/definitions/AuthorType"
    },
    "Title": {
      "description": "The title of the book",
      "type": "string"
    }
  }
}
```

That defines a Book type as the root of the schema which has an Author and a Title. The Author is a type defined in another schema and Title is a string.

We would like to represent a Book type in Clojure like the following

```
(defrecord Book
  [
   ;; The author of this book
   Author

   ;; The title of the book
   Title
  ])
```

The code in `cmr.umm-spec.record-generator` can generate records from a schema. The UMM Clojure records can be generated by running `lein generate-umm-records` in this project.


## Implementing mapping for a new field

Adding mappings for a new or existing field in the UMM should be done at the same time across all formats.

### 1. Obtain the XPaths and example XML samples.

Contact Erich Reiter (erich.e.reiter@nasa.gov) to obtain these.

### 2. Implement tests for each format.

Add roundtrip conversion tests for each format in `cmr.umm-spec.test.generate-and-parse`

### 3. Implement the UMM to XML mappings for each format.

The UMM to XML mappings are in files named `resources/mappings/<format>/umm-to-<format>-xml.json`

A field mapping is a tuple of element name and map with instructions on how to extract the value from the UMM record. A list of tuples is used when specifying a list of fields instead of a map because JSON maps can not be loaded in a way that maintains key order.

Example:

In this example "DataSetId" is the element name for the ECHO10 XML. The value will be extracted from the UMM Clojure records using an XPath. XPaths are used as a convenient way to specify the location for extracting a value from a Clojure record.

```
["DataSetId", {
  "type": "xpath",
  "value": "/UMM-C/EntryTitle"
}],
```

### 4. Implement the XML to UMM mappings for each format.

The UMM to XML mappings are in files named `resources/mappings/<format>/<format>-xml-to-umm.json`

Example:

This example shows that a field called "EntryTitle" in the collection record will be set with the value extracted from the ECHO10 XML at the XPath /Collection/DataSetId.

```
"EntryTitle": {
  "type": "xpath",
  "value": "/Collection/DataSetId"
},
```

## License

Copyright Â© 2015 NASA
